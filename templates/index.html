<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Analyser Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-main">
                <div class="title-section">
                    <h1>PE Analyser Dashboard</h1>
                </div>
                <div class="right-controls">
                    <div class="upload-status" id="uploadStatus">
                        <div class="compact-upload" id="compactUpload" title="Upload CSV file (max 16MB) or drag & drop anywhere">
                            <input type="file" id="fileInput" class="file-input" accept=".csv">
                            <button class="compact-upload-btn" onclick="document.getElementById('fileInput').click()">
                                ðŸ“Š Upload CSV
                            </button>
                        </div>
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            Processing your file...
                        </div>
                        <div id="alertContainer"></div>
                    </div>
                    
                    <!-- View Type Selector -->
                    <div class="view-selector" id="viewSelector" style="display: none;">
                        <label for="viewType">View by:</label>
                        <select id="viewType" onchange="changeViewType()">
                            <option value="month">Month</option>
                            <option value="fiscal_year">Fiscal Year</option>
                            <option value="quarter">Quarter (by FY)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="dashboard-layout">
                <div class="main-content">
                    <div class="stats-grid">
                        <div class="stat-card pharmacy-highlight">
                            <div class="stat-number" id="uniquePharmacies">0</div>
                            <div class="stat-label">Acquired Pharmacies + Pipelines</div>
                        </div>
                        
                        <div class="stat-card revenue-highlight clickable-card" id="monthlyRevenueCard" onclick="showMonthlyRevenueModal()">
                            <div class="stat-number" id="monthlyRevenue">Â£0</div>
                            <div class="revenue-change" id="revenueChange" style="display: none;">
                                <span class="change-icon" id="changeIcon"></span>
                                <span class="change-percentage" id="changePercentage"></span>
                            </div>
                            <div class="stat-label" id="monthlyRevenueLabel">Current Live Month Revenue</div>
                            <div class="card-hint">Click to select month</div>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <div class="chart-container">
                            <h2>Total Revenue by Pharmacy Over Time</h2>
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="pharmacy-selector">
                        <h3>Select Pharmacies</h3>
                        <div class="selector-controls">
                            <button class="select-btn" onclick="selectAll()">All</button>
                            <button class="select-btn" onclick="clearAllSelections()">None</button>
                            <button class="update-btn" onclick="updateChartWithSelection()">Update Chart</button>
                        </div>
                        <div class="pharmacy-checkboxes" id="pharmacyCheckboxes">
                            <!-- Pharmacy checkboxes will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed pharmacies modal - now using sidebar -->

    <!-- Monthly Revenue Modal -->
    <div id="monthlyRevenueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Month for Revenue</h2>
                <span class="close" onclick="closeMonthlyRevenueModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="current-selection">
                    <h3>Current Selection: <span id="selectedMonthDisplay">Loading...</span></h3>
                    <div class="current-revenue">
                        <span class="revenue-amount" id="selectedMonthRevenue">Â£0</span>
                        <span class="revenue-subtitle">Total Revenue (All Pharmacies)</span>
                    </div>
                </div>
                <div class="month-selector">
                    <h4>Select Different Month:</h4>
                    <div id="monthsList" class="months-grid">
                        <!-- Month buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const compactUpload = document.getElementById('compactUpload');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const dashboard = document.getElementById('dashboard');
        const alertContainer = document.getElementById('alertContainer');
        
        // Chart variables
        let revenueChart = null;
        const ctx = document.getElementById('revenueChart').getContext('2d');

        // Drag and drop functionality on entire page
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            compactUpload.style.opacity = '0.7';
            compactUpload.style.transform = 'scale(1.05)';
        });

        document.addEventListener('dragleave', (e) => {
            // Only remove highlight if we're leaving the document
            if (!e.relatedTarget) {
                compactUpload.style.opacity = '1';
                compactUpload.style.transform = 'scale(1)';
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            compactUpload.style.opacity = '1';
            compactUpload.style.transform = 'scale(1)';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function hideAlert() {
            alertContainer.innerHTML = '';
        }

        function showLoading() {
            loading.style.display = 'block';
            hideAlert();
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function updateStats(stats) {
            // Add error checking to prevent undefined values
            if (stats && typeof stats === 'object') {
                // Update only the elements that exist in the DOM
                const uniquePharmaciesEl = document.getElementById('uniquePharmacies');
                const totalRowsEl = document.getElementById('totalRows');
                const uniqueClustersEl = document.getElementById('uniqueClusters');
                const uniqueMetricsEl = document.getElementById('uniqueMetrics');
                
                if (uniquePharmaciesEl) {
                    uniquePharmaciesEl.textContent = (stats.unique_pharmacies || 0).toLocaleString();
                }
                if (totalRowsEl) {
                    totalRowsEl.textContent = (stats.total_rows || 0).toLocaleString();
                }
                if (uniqueClustersEl) {
                    uniqueClustersEl.textContent = (stats.unique_clusters || 0).toLocaleString();
                }
                if (uniqueMetricsEl) {
                    uniqueMetricsEl.textContent = (stats.unique_metrics || 0).toLocaleString();
                }
                
                dashboard.style.display = 'block';
                // Show the view selector
                document.getElementById('viewSelector').style.display = 'block';
                loadPharmacySelector();
                loadCurrentPeriodRevenue();
            } else {
                console.error('Invalid stats data:', stats);
                showAlert('Error displaying statistics', 'error');
            }
        }

        function loadPharmacySelector() {
            fetch('/api/pharmacies')
            .then(response => response.json())
            .then(pharmacies => {
                if (Array.isArray(pharmacies)) {
                    createPharmacyCheckboxes(pharmacies);
                    // Auto-select all pharmacies and load chart
                    selectAll();
                }
            })
            .catch(error => {
                console.error('Error fetching pharmacies:', error);
            });
        }

        function createPharmacyCheckboxes(pharmacies) {
            const container = document.getElementById('pharmacyCheckboxes');
            container.innerHTML = '';
            
            pharmacies.forEach(pharmacy => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'pharmacy-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `pharmacy_${pharmacy}`;
                checkbox.value = pharmacy;
                
                const label = document.createElement('label');
                label.htmlFor = `pharmacy_${pharmacy}`;
                label.textContent = pharmacy;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }


        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function getSelectedPharmacies() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        function updateChartWithSelection() {
            const selectedPharmacies = getSelectedPharmacies();
            if (selectedPharmacies.length === 0) {
                if (revenueChart) {
                    revenueChart.destroy();
                    revenueChart = null;
                }
                return;
            }
            loadRevenueChart(selectedPharmacies);
        }

        function loadRevenueChart(selectedPharmacies = null) {
            let url = '/api/revenue-data';
            const params = new URLSearchParams();
            
            // Add view type parameter
            params.append('view_type', currentViewType);
            
            // Add pharmacy filter if provided
            if (selectedPharmacies && selectedPharmacies.length > 0) {
                params.append('pharmacies', selectedPharmacies.join(','));
            }
            
            url += '?' + params.toString();
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading chart data:', data.error);
                    return;
                }
                createRevenueChart(data);
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
            });
        }

        function createRevenueChart(data) {
            // Destroy existing chart if it exists
            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Revenue by Pharmacy Over Time'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Revenue (Â£)'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    }
                }
            });
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('Please select a CSV file.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showLoading();

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    current_data = null;
                } else {
                    showAlert(data.message, 'success');
                    // Handle both response structures: nested stats or direct stats
                    const statsData = data.stats || data;
                    current_data = true; // Mark that data has been loaded
                    updateStats(statsData);
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Error uploading file: ' + error.message, 'error');
            });
        }

        // Load stats on page load if data exists
        fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                current_data = true; // Mark that data exists
                updateStats(data);
            }
        })
        .catch(error => {
            console.log('No existing data loaded');
        });

        // Modal functionality (removed pharmacies modal functions - now using sidebar)
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const revenueModal = document.getElementById('monthlyRevenueModal');
            
            if (event.target === revenueModal) {
                closeMonthlyRevenueModal();
            }
        }

        // Make current_data accessible for modal check
        let current_data = null;
        let currentSelectedPeriod = null;
        let currentViewType = 'month';

        // View Type Change Handler
        function changeViewType() {
            const viewType = document.getElementById('viewType').value;
            currentViewType = viewType;
            
            // Update labels based on view type
            updateViewLabels(viewType);
            
            // Reload revenue data for the new view type
            loadCurrentPeriodRevenue();
            
            // Update chart if pharmacy selector is loaded
            if (document.querySelector('#pharmacyCheckboxes').children.length > 0) {
                updateChartWithSelection();
            }
        }

        function updateViewLabels(viewType) {
            const cardLabel = document.getElementById('monthlyRevenueLabel');
            const modalTitle = document.querySelector('#monthlyRevenueModal .modal-header h2');
            const modalSubtitle = document.querySelector('.month-selector h4');
            
            switch(viewType) {
                case 'month':
                    if (cardLabel) cardLabel.textContent = 'Current Live Month Revenue';
                    if (modalTitle) modalTitle.textContent = 'Select Month for Revenue';
                    if (modalSubtitle) modalSubtitle.textContent = 'Select Different Month:';
                    break;
                case 'fiscal_year':
                    if (cardLabel) cardLabel.textContent = 'Current Fiscal Year Revenue';
                    if (modalTitle) modalTitle.textContent = 'Select Fiscal Year for Revenue';
                    if (modalSubtitle) modalSubtitle.textContent = 'Select Different Fiscal Year:';
                    break;
                case 'quarter':
                    if (cardLabel) cardLabel.textContent = 'Current Quarter Revenue';
                    if (modalTitle) modalTitle.textContent = 'Select Quarter for Revenue';
                    if (modalSubtitle) modalSubtitle.textContent = 'Select Different Quarter:';
                    break;
            }
        }

        // Monthly Revenue Modal Functions
        function showMonthlyRevenueModal() {
            if (current_data === null) {
                showAlert('No data loaded. Please upload a CSV file first.', 'error');
                return;
            }
            
            // Fetch available periods and current period revenue
            fetch(`/api/revenue-by-period?view_type=${currentViewType}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Error loading revenue data: ' + data.error, 'error');
                } else {
                    populatePeriodsList(data.periods, data.current_period, data.current_revenue);
                    document.getElementById('monthlyRevenueModal').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching revenue data:', error);
                showAlert('Error loading revenue data', 'error');
            });
        }

        function closeMonthlyRevenueModal() {
            document.getElementById('monthlyRevenueModal').style.display = 'none';
        }

        function populatePeriodsList(periods, currentPeriod, currentRevenue) {
            currentSelectedPeriod = currentPeriod;
            
            // Find current period data for percentage change
            const currentPeriodData = periods.find(p => p.period === currentPeriod);
            
            // Update current selection display
            document.getElementById('selectedMonthDisplay').textContent = currentPeriod;
            document.getElementById('selectedMonthRevenue').textContent = 'Â£' + currentRevenue.toLocaleString();
            
            // Update main card percentage change if current period data exists
            if (currentPeriodData) {
                const revenueChangeEl = document.getElementById('revenueChange');
                const changeIconEl = document.getElementById('changeIcon');
                const changePercentageEl = document.getElementById('changePercentage');
                
                if (currentPeriodData.percentage_change !== null) {
                    const icon = currentPeriodData.change_direction === 'increase' ? 'â†—' : 'â†˜';
                    const colorClass = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const changeText = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                            currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                    
                    changeIconEl.textContent = icon;
                    changePercentageEl.textContent = Math.abs(currentPeriodData.percentage_change) + '%';
                    
                    revenueChangeEl.className = `revenue-change ${colorClass}`;
                    revenueChangeEl.title = `${Math.abs(currentPeriodData.percentage_change)}% ${changeText} from ${previousPeriodText}`;
                    revenueChangeEl.style.display = 'flex';
                } else {
                    revenueChangeEl.style.display = 'none';
                }
            }
            
            // Populate periods grid
            const periodsList = document.getElementById('monthsList');
            periodsList.innerHTML = '';
            
            periods.forEach(periodData => {
                const periodButton = document.createElement('button');
                periodButton.className = 'month-button';
                if (periodData.period === currentPeriod) {
                    periodButton.classList.add('selected');
                }
                
                // Create percentage change display
                let changeDisplay = '';
                if (periodData.percentage_change !== null) {
                    const changeClass = periodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const changeIcon = periodData.change_direction === 'increase' ? 'â†—' : 'â†˜';
                    const changeText = periodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                            currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                    changeDisplay = `
                        <div class="month-change ${changeClass}" title="${Math.abs(periodData.percentage_change)}% ${changeText} from ${previousPeriodText}">
                            <span class="change-icon">${changeIcon}</span>
                            <span>${Math.abs(periodData.percentage_change)}%</span>
                        </div>
                    `;
                }
                
                periodButton.innerHTML = `
                    <div class="month-name">${periodData.period}</div>
                    <div class="month-revenue">Â£${periodData.revenue.toLocaleString()}</div>
                    ${changeDisplay}
                `;
                
                periodButton.onclick = () => selectPeriod(periodData.period, periodData.revenue, periodData.percentage_change, periodData.change_direction);
                periodsList.appendChild(periodButton);
            });
        }

        function selectPeriod(period, revenue, percentageChange, changeDirection) {
            currentSelectedPeriod = period;
            
            // Update display
            document.getElementById('selectedMonthDisplay').textContent = period;
            document.getElementById('selectedMonthRevenue').textContent = 'Â£' + revenue.toLocaleString();
            
            // Update main scorecard
            document.getElementById('monthlyRevenue').textContent = 'Â£' + revenue.toLocaleString();
            document.getElementById('monthlyRevenueLabel').textContent = period + ' Revenue';
            
            // Update percentage change in main card
            const revenueChangeEl = document.getElementById('revenueChange');
            const changeIconEl = document.getElementById('changeIcon');
            const changePercentageEl = document.getElementById('changePercentage');
            
                                     if (percentageChange !== null) {
                const icon = changeDirection === 'increase' ? 'â†—' : 'â†˜';
                const colorClass = changeDirection === 'increase' ? 'increase' : 'decrease';
                const changeText = changeDirection === 'increase' ? 'increase' : 'decrease';
                const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                        currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                
                changeIconEl.textContent = icon;
                changePercentageEl.textContent = Math.abs(percentageChange) + '%';
                
                revenueChangeEl.className = `revenue-change ${colorClass}`;
                revenueChangeEl.title = `${Math.abs(percentageChange)}% ${changeText} from ${previousPeriodText}`;
                revenueChangeEl.style.display = 'flex';
            } else {
                revenueChangeEl.style.display = 'none';
            }
            
            // Update button selection
            document.querySelectorAll('.month-button').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.month-button').classList.add('selected');
        }

        function loadCurrentPeriodRevenue() {
            if (current_data === null) return;
            
            fetch(`/api/revenue-by-period?view_type=${currentViewType}`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('monthlyRevenue').textContent = 'Â£' + data.current_revenue.toLocaleString();
                    
                    // Update label based on view type
                    let labelSuffix = '';
                    if (currentViewType === 'month') {
                        labelSuffix = ' (Current Live Month)';
                    } else if (currentViewType === 'fiscal_year') {
                        labelSuffix = ' (Current Fiscal Year)';
                    } else if (currentViewType === 'quarter') {
                        labelSuffix = ' (Current Quarter)';
                    }
                    document.getElementById('monthlyRevenueLabel').textContent = data.live_period + ' Revenue' + labelSuffix;
                    
                    // Find current period data for percentage change
                    const currentPeriodData = data.periods.find(p => p.period === data.current_period);
                    const revenueChangeEl = document.getElementById('revenueChange');
                    const changeIconEl = document.getElementById('changeIcon');
                    const changePercentageEl = document.getElementById('changePercentage');
                    
                    if (currentPeriodData && currentPeriodData.percentage_change !== null) {
                        const icon = currentPeriodData.change_direction === 'increase' ? 'â†—' : 'â†˜';
                        const colorClass = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                        const changeText = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                        const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                                currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                        
                        changeIconEl.textContent = icon;
                        changePercentageEl.textContent = Math.abs(currentPeriodData.percentage_change) + '%';
                        
                        revenueChangeEl.className = `revenue-change ${colorClass}`;
                        revenueChangeEl.title = `${Math.abs(currentPeriodData.percentage_change)}% ${changeText} from ${previousPeriodText}`;
                        revenueChangeEl.style.display = 'flex';
                    } else {
                        revenueChangeEl.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading current period revenue:', error);
            });
        }
    </script>
</body>
</html> 