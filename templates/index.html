<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Analyser Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-main">
                <div class="title-section">
                    <h1>PE Analyser Dashboard</h1>
                </div>
                <div class="right-controls">
                    <div class="upload-status" id="uploadStatus">
                        <div class="compact-upload" id="compactUpload" title="Upload CSV file (max 16MB) or drag & drop anywhere">
                            <input type="file" id="fileInput" class="file-input" accept=".csv">
                            <button class="compact-upload-btn" onclick="document.getElementById('fileInput').click()">
                                üìä Upload CSV
                            </button>
                        </div>
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            Processing your file...
                        </div>
                        <div id="alertContainer"></div>
                    </div>
                    
                    <!-- View Type Selector -->
                    <div class="view-selector" id="viewSelector" style="display: none;">
                        <label for="viewType">View by:</label>
                        <select id="viewType" onchange="changeViewType()">
                            <option value="month">Month</option>
                            <option value="fiscal_year">Fiscal Year</option>
                            <option value="quarter">Quarter (by FY)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="dashboard-layout">
                <div class="main-content">
                    <div class="stats-grid">
                        <div class="stat-card pharmacy-highlight clickable-card" id="pharmaciesCard" onclick="showPharmaciesListModal()">
                            <div class="stat-number" id="uniquePharmacies">0</div>
                            <div class="stat-label">Acquired Pharmacies + Pipelines</div>
                            <div class="card-hint">Click to view list</div>
                        </div>
                        
                        <div class="stat-card revenue-highlight clickable-card" id="monthlyRevenueCard" onclick="showMonthlyRevenueModal()">
                            <div class="stat-number" id="monthlyRevenue">¬£0</div>
                            <div class="revenue-change" id="revenueChange" style="display: none;">
                                <span class="change-icon" id="changeIcon"></span>
                                <span class="change-percentage" id="changePercentage"></span>
                            </div>
                            <div class="stat-label" id="monthlyRevenueLabel">Current Live Month Revenue</div>
                            <div class="card-hint">Click to select month</div>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <div class="chart-container">
                            <h2>Total Revenue by Pharmacy Over Time</h2>
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="pharmacy-selector">
                        <h3>Select Pharmacies</h3>
                        
                        <!-- Acquisition Filter Toggle -->
                        <div class="acquisition-toggle">
                            <label class="toggle-container">
                                <input type="checkbox" id="acquisitionFilter" onchange="toggleAcquisitionFilter()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">From acquisition date only</span>
                            </label>
                            <p class="toggle-hint">Show data only from each pharmacy's acquisition date onwards</p>
                        </div>
                        
                        <!-- Date Range Selector (only for month view) -->
                        <div class="date-range-selector" id="dateRangeSelector" style="display: none;">
                            <h4>Custom Date Range</h4>
                            <div class="date-inputs">
                                <div class="date-input-group">
                                    <label for="startMonth">From:</label>
                                    <select id="startMonth" onchange="updateDateRange()">
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                                <div class="date-input-group">
                                    <label for="endMonth">To:</label>
                                    <select id="endMonth" onchange="updateDateRange()">
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                            </div>
                            <button class="reset-range-btn" onclick="resetDateRange()">Reset to All</button>
                        </div>
                        
                        <!-- Quarter Range Selector (only for quarter view) -->
                        <div class="date-range-selector" id="quarterRangeSelector" style="display: none;">
                            <h4>Custom Quarter Range</h4>
                            <div class="date-inputs">
                                <div class="date-input-group">
                                    <label for="startQuarter">From:</label>
                                    <select id="startQuarter" onchange="updateQuarterRange()">
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                                <div class="date-input-group">
                                    <label for="endQuarter">To:</label>
                                    <select id="endQuarter" onchange="updateQuarterRange()">
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                            </div>
                            <button class="reset-range-btn" onclick="resetQuarterRange()">Reset to All</button>
                        </div>
                        
                        <div class="selector-controls">
                            <button class="select-btn" onclick="selectAll()">All</button>
                            <button class="select-btn" onclick="clearAllSelections()">Deselect All</button>
                            <button class="update-btn" onclick="updateChartWithSelection()">Update Chart</button>
                        </div>
                        
                        <!-- Status Legend -->
                        <div class="status-legend">
                            <div class="legend-item">
                                <span class="status-icon acquired">‚óè</span>
                                <span>Acquired</span>
                            </div>
                            <div class="legend-item">
                                <span class="status-icon pipeline">‚óè</span>
                                <span>Pipeline</span>
                            </div>
                        </div>
                        
                        <div class="pharmacy-checkboxes" id="pharmacyCheckboxes">
                            <!-- Pharmacy checkboxes will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pharmacies List Modal -->
    <div id="pharmaciesListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pharmacy List</h2>
                <span class="close" onclick="closePharmaciesListModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="pharmacy-summary">
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="status-icon acquired">‚óè</span>
                            <span class="summary-label">Acquired:</span>
                            <span class="summary-count" id="acquiredCount">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="status-icon pipeline">‚óè</span>
                            <span class="summary-label">Pipeline:</span>
                            <span class="summary-count" id="pipelineCount">0</span>
                        </div>
                    </div>
                </div>
                <div id="pharmaciesListDisplay" class="pharmacies-list-display">
                    <!-- Pharmacy list will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Revenue Modal -->
    <div id="monthlyRevenueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Month for Revenue</h2>
                <span class="close" onclick="closeMonthlyRevenueModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="current-selection">
                    <h3>Current Selection: <span id="selectedMonthDisplay">Loading...</span></h3>
                    <div class="current-revenue">
                        <span class="revenue-amount" id="selectedMonthRevenue">¬£0</span>
                        <span class="revenue-subtitle">Total Revenue (All Pharmacies)</span>
                    </div>
                </div>
                <div class="month-selector">
                    <h4>Select Different Month:</h4>
                    <div id="monthsList" class="months-grid">
                        <!-- Month buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const compactUpload = document.getElementById('compactUpload');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const dashboard = document.getElementById('dashboard');
        const alertContainer = document.getElementById('alertContainer');
        
        // Chart variables
        let revenueChart = null;
        const ctx = document.getElementById('revenueChart').getContext('2d');

        // Drag and drop functionality on entire page
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            compactUpload.style.opacity = '0.7';
            compactUpload.style.transform = 'scale(1.05)';
        });

        document.addEventListener('dragleave', (e) => {
            // Only remove highlight if we're leaving the document
            if (!e.relatedTarget) {
                compactUpload.style.opacity = '1';
                compactUpload.style.transform = 'scale(1)';
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            compactUpload.style.opacity = '1';
            compactUpload.style.transform = 'scale(1)';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function hideAlert() {
            alertContainer.innerHTML = '';
        }

        function showLoading() {
            loading.style.display = 'block';
            hideAlert();
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function updateStats(stats) {
            // Add error checking to prevent undefined values
            if (stats && typeof stats === 'object') {
                // Update only the elements that exist in the DOM
                const uniquePharmaciesEl = document.getElementById('uniquePharmacies');
                const totalRowsEl = document.getElementById('totalRows');
                const uniqueClustersEl = document.getElementById('uniqueClusters');
                const uniqueMetricsEl = document.getElementById('uniqueMetrics');
                
                if (uniquePharmaciesEl) {
                    uniquePharmaciesEl.textContent = (stats.unique_pharmacies || 0).toLocaleString();
                }
                if (totalRowsEl) {
                    totalRowsEl.textContent = (stats.total_rows || 0).toLocaleString();
                }
                if (uniqueClustersEl) {
                    uniqueClustersEl.textContent = (stats.unique_clusters || 0).toLocaleString();
                }
                if (uniqueMetricsEl) {
                    uniqueMetricsEl.textContent = (stats.unique_metrics || 0).toLocaleString();
                }
                
                dashboard.style.display = 'block';
                // Show the view selector
                document.getElementById('viewSelector').style.display = 'block';
                
                // Initialize date range selector for default month view
                initializeDateRangeSelector();
                
                loadPharmacySelector();
                loadCurrentPeriodRevenue();
            } else {
                console.error('Invalid stats data:', stats);
                showAlert('Error displaying statistics', 'error');
            }
        }

        function loadPharmacySelector() {
            fetch('/api/pharmacies')
            .then(response => response.json())
            .then(pharmacyDetails => {
                if (Array.isArray(pharmacyDetails)) {
                    createPharmacyCheckboxes(pharmacyDetails);
                    // Auto-select all pharmacies and load chart
                    selectAll();
                }
            })
            .catch(error => {
                console.error('Error fetching pharmacies:', error);
            });
        }

        function toggleAcquisitionFilter() {
            const acquisitionFilter = document.getElementById('acquisitionFilter');
            
            if (acquisitionFilter.checked) {
                // When acquisition filter is enabled, automatically deselect pipeline pharmacies
                const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (checkbox.dataset.status === 'pipeline') {
                        checkbox.checked = false;
                    }
                });
                
                // Show visual feedback
                showAlert('Pipeline pharmacies automatically deselected (no acquisition dates)', 'info');
                setTimeout(() => hideAlert(), 3000);
            }
            
            // Update chart when acquisition filter toggle changes
            updateChartWithSelection();
        }

        // Date range functionality
        function initializeDateRangeSelector() {
            const dateRangeSelector = document.getElementById('dateRangeSelector');
            const quarterRangeSelector = document.getElementById('quarterRangeSelector');
            
            if (currentViewType === 'month') {
                dateRangeSelector.style.display = 'block';
                quarterRangeSelector.style.display = 'none';
                populateDateRangeOptions();
            } else if (currentViewType === 'quarter') {
                dateRangeSelector.style.display = 'none';
                quarterRangeSelector.style.display = 'block';
                populateQuarterRangeOptions();
            } else {
                dateRangeSelector.style.display = 'none';
                quarterRangeSelector.style.display = 'none';
            }
        }

        function populateDateRangeOptions() {
            const startSelect = document.getElementById('startMonth');
            const endSelect = document.getElementById('endMonth');
            
            // Clear existing options
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            // Generate months from Apr 2024 to current month (inclusive)
            const startDate = new Date('2024-04-01');
            const currentDate = new Date();
            
            console.log('Generating date range. Current month:', currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
            
            const months = [];
            let date = new Date(startDate);
            
            // Loop until we've included the current month
            while (date.getFullYear() < currentDate.getFullYear() || 
                   (date.getFullYear() === currentDate.getFullYear() && date.getMonth() <= currentDate.getMonth())) {
                const monthStr = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                const value = date.toISOString().substring(0, 7); // YYYY-MM format
                months.push({ value, display: monthStr, date: new Date(date) });
                date.setMonth(date.getMonth() + 1);
            }
            
            // Populate start month options
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.display;
                startSelect.appendChild(option);
            });
            
            // Populate end month options
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.display;
                endSelect.appendChild(option);
            });
            
            // Log the months that were generated
            console.log('Generated months:', months.map(m => m.display));
            
            // Set default values (start: Apr 2024, end: one month before current)
            startSelect.value = '2024-04';
            
            // Set end date to one month before current month
            const defaultEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const defaultEndValue = defaultEndDate.toISOString().substring(0, 7);
            
            console.log('Default end month (one month before current):', defaultEndDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
            
            // Ensure the default end date exists in our options (in case it's before Apr 2024)
            if (defaultEndValue >= '2024-04') {
                endSelect.value = defaultEndValue;
            } else {
                // If one month before is before Apr 2024, default to Apr 2024
                endSelect.value = '2024-04';
            }
        }

        function updateDateRange() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            // Validate that start is before or equal to end
            if (startMonth > endMonth) {
                document.getElementById('endMonth').value = startMonth;
            }
            
            // Update chart with new date range
            updateChartWithSelection();
        }

        function resetDateRange() {
            const currentDate = new Date();
            
            document.getElementById('startMonth').value = '2024-04';
            
            // Reset end date to one month before current month
            const defaultEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const defaultEndValue = defaultEndDate.toISOString().substring(0, 7);
            
            // Ensure the default end date exists in our options (in case it's before Apr 2024)
            if (defaultEndValue >= '2024-04') {
                document.getElementById('endMonth').value = defaultEndValue;
            } else {
                // If one month before is before Apr 2024, default to Apr 2024
                document.getElementById('endMonth').value = '2024-04';
            }
            
            updateChartWithSelection();
        }

        function getSelectedDateRange() {
            if (currentViewType !== 'month') {
                return null;
            }
            
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            return {
                start: startMonth,
                end: endMonth
            };
        }

        // Quarter range functionality
        function populateQuarterRangeOptions() {
            const startSelect = document.getElementById('startQuarter');
            const endSelect = document.getElementById('endQuarter');
            
            // Clear existing options
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            // Generate quarters from Q1 FY2025 to current quarter
            const currentDate = new Date();
            console.log('Generating quarter range. Current date:', currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
            
            // Calculate current fiscal year and quarter
            let currentFY, currentQ;
            if (currentDate.getMonth() < 3 || (currentDate.getMonth() === 3 && currentDate.getDate() < 6)) {
                currentFY = currentDate.getFullYear();
            } else {
                currentFY = currentDate.getFullYear() + 1;
            }
            
            // Determine current quarter (Apr-Jun=Q1, Jul-Sep=Q2, Oct-Dec=Q3, Jan-Mar=Q4)
            const month = currentDate.getMonth() + 1; // 1-based month
            if (month >= 4 && month <= 6) {
                currentQ = 'Q1';
            } else if (month >= 7 && month <= 9) {
                currentQ = 'Q2';
            } else if (month >= 10 && month <= 12) {
                currentQ = 'Q3';
            } else { // Jan-Mar
                currentQ = 'Q4';
            }
            
            console.log('Current quarter:', currentQ, 'FY' + currentFY);
            
            const quarters = [];
            
            // Start from Q1 FY2025 and go to current quarter
            for (let fy = 2025; fy <= currentFY; fy++) {
                const quarterList = ['Q1', 'Q2', 'Q3', 'Q4'];
                
                for (const q of quarterList) {
                    // If we're in the current FY, only include quarters up to current
                    if (fy === currentFY) {
                        const qNum = parseInt(q.replace('Q', ''));
                        const currentQNum = parseInt(currentQ.replace('Q', ''));
                        if (qNum > currentQNum) {
                            break;
                        }
                    }
                    
                    quarters.push({
                        value: `${q}-FY${fy}`,
                        display: `${q} FY${fy}`,
                        fy: fy,
                        quarter: q
                    });
                }
            }
            
            console.log('Generated quarters:', quarters.map(q => q.display));
            
            // Populate start quarter options
            quarters.forEach(quarter => {
                const option = document.createElement('option');
                option.value = quarter.value;
                option.textContent = quarter.display;
                startSelect.appendChild(option);
            });
            
            // Populate end quarter options
            quarters.forEach(quarter => {
                const option = document.createElement('option');
                option.value = quarter.value;
                option.textContent = quarter.display;
                endSelect.appendChild(option);
            });
            
            // Set default values (start: Q1 FY2025, end: one quarter before current)
            startSelect.value = 'Q1-FY2025';
            
            // Set end to one quarter before current
            const currentIndex = quarters.findIndex(q => q.quarter === currentQ && q.fy === currentFY);
            const defaultEndIndex = Math.max(0, currentIndex - 1);
            const defaultEndQuarter = quarters[defaultEndIndex];
            
            console.log('Default end quarter (one quarter before current):', defaultEndQuarter.display);
            endSelect.value = defaultEndQuarter.value;
        }

        function updateQuarterRange() {
            const startQuarter = document.getElementById('startQuarter').value;
            const endQuarter = document.getElementById('endQuarter').value;
            
            // Basic validation - could be enhanced
            const startParts = startQuarter.split('-');
            const endParts = endQuarter.split('-');
            
            if (startParts[1] > endParts[1] || 
                (startParts[1] === endParts[1] && startParts[0] > endParts[0])) {
                document.getElementById('endQuarter').value = startQuarter;
            }
            
            // Update chart with new quarter range
            updateChartWithSelection();
        }

        function resetQuarterRange() {
            const currentDate = new Date();
            let currentFY;
            if (currentDate.getMonth() < 3 || (currentDate.getMonth() === 3 && currentDate.getDate() < 6)) {
                currentFY = currentDate.getFullYear();
            } else {
                currentFY = currentDate.getFullYear() + 1;
            }
            
            // Determine current quarter
            const month = currentDate.getMonth() + 1;
            let currentQ;
            if (month >= 4 && month <= 6) {
                currentQ = 'Q1';
            } else if (month >= 7 && month <= 9) {
                currentQ = 'Q2';
            } else if (month >= 10 && month <= 12) {
                currentQ = 'Q3';
            } else {
                currentQ = 'Q4';
            }
            
            document.getElementById('startQuarter').value = 'Q1-FY2025';
            
            // Set to one quarter before current
            let defaultQ, defaultFY;
            if (currentQ === 'Q1') {
                defaultQ = 'Q4';
                defaultFY = currentFY - 1;
            } else {
                const qNum = parseInt(currentQ.replace('Q', ''));
                defaultQ = 'Q' + (qNum - 1);
                defaultFY = currentFY;
            }
            
            document.getElementById('endQuarter').value = `${defaultQ}-FY${defaultFY}`;
            updateChartWithSelection();
        }

        function getSelectedQuarterRange() {
            if (currentViewType !== 'quarter') {
                return null;
            }
            
            const startQuarter = document.getElementById('startQuarter').value;
            const endQuarter = document.getElementById('endQuarter').value;
            
            return {
                start: startQuarter,
                end: endQuarter
            };
        }

        function createPharmacyCheckboxes(pharmacyDetails) {
            const container = document.getElementById('pharmacyCheckboxes');
            container.innerHTML = '';
            
            // Sort by status (acquired first) then by name
            pharmacyDetails.sort((a, b) => {
                if (a.status === b.status) {
                    return a.name.localeCompare(b.name);
                }
                return a.status === 'acquired' ? -1 : 1;
            });
            
            pharmacyDetails.forEach(pharmacy => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'pharmacy-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `pharmacy_${pharmacy.name}`;
                checkbox.value = pharmacy.name;
                checkbox.dataset.status = pharmacy.status;
                checkbox.dataset.acquisitionDate = pharmacy.acquisition_date || '';
                
                const statusIcon = document.createElement('span');
                statusIcon.className = `status-icon ${pharmacy.status}`;
                statusIcon.textContent = '‚óè';
                
                const label = document.createElement('label');
                label.htmlFor = `pharmacy_${pharmacy.name}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'pharmacy-name';
                nameSpan.textContent = pharmacy.name;
                
                const dateSpan = document.createElement('span');
                dateSpan.className = 'pharmacy-date';
                if (pharmacy.acquisition_date) {
                    dateSpan.textContent = ` (${pharmacy.acquisition_date})`;
                }
                
                label.appendChild(nameSpan);
                if (pharmacy.acquisition_date) {
                    label.appendChild(dateSpan);
                }
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(statusIcon);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }


        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function getSelectedPharmacies() {
            const checkboxes = document.querySelectorAll('#pharmacyCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        function updateChartWithSelection() {
            const selectedPharmacies = getSelectedPharmacies();
            if (selectedPharmacies.length === 0) {
                if (revenueChart) {
                    revenueChart.destroy();
                    revenueChart = null;
                }
                return;
            }
            loadRevenueChart(selectedPharmacies);
        }

        function loadRevenueChart(selectedPharmacies = null) {
            console.log('Loading revenue chart for view type:', currentViewType);
            console.log('Selected pharmacies:', selectedPharmacies);
            
            let url = '/api/revenue-data';
            const params = new URLSearchParams();
            
            // Add view type parameter
            params.append('view_type', currentViewType);
            
            // Add pharmacy filter if provided
            if (selectedPharmacies && selectedPharmacies.length > 0) {
                params.append('pharmacies', selectedPharmacies.join(','));
            }
            
            // Add acquisition filter parameter
            const acquisitionFilter = document.getElementById('acquisitionFilter');
            if (acquisitionFilter && acquisitionFilter.checked) {
                params.append('acquisition_filter', 'true');
                
                // Send acquisition dates for the selected pharmacies
                const acquisitionDates = {};
                selectedPharmacies?.forEach(pharmacy => {
                    const checkbox = document.querySelector(`input[value="${pharmacy}"]`);
                    if (checkbox && checkbox.dataset.acquisitionDate) {
                        acquisitionDates[pharmacy] = checkbox.dataset.acquisitionDate;
                    }
                });
                
                if (Object.keys(acquisitionDates).length > 0) {
                    params.append('acquisition_dates', JSON.stringify(acquisitionDates));
                }
            }
            
            // Add date range parameter for month view
            const dateRange = getSelectedDateRange();
            if (dateRange) {
                params.append('date_range_start', dateRange.start);
                params.append('date_range_end', dateRange.end);
            }
            
            // Add quarter range parameter for quarter view
            const quarterRange = getSelectedQuarterRange();
            if (quarterRange) {
                params.append('quarter_range_start', quarterRange.start);
                params.append('quarter_range_end', quarterRange.end);
            }
            
            url += '?' + params.toString();
            
            console.log('Fetching data from URL:', url);
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('Received data from API:', data);
                if (data.error) {
                    console.error('Error loading chart data:', data.error);
                    return;
                }
                createRevenueChart(data);
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
            });
        }

        function createRevenueChart(data) {
            console.log('Creating chart with data:', data);
            console.log('Current view type:', currentViewType);
            
            // Destroy existing chart if it exists
            if (revenueChart) {
                revenueChart.destroy();
            }

            // Determine x-axis label based on view type
            let xAxisLabel = 'Month';
            if (currentViewType === 'fiscal_year') {
                xAxisLabel = 'Fiscal Year';
            } else if (currentViewType === 'quarter') {
                xAxisLabel = 'Quarter';
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Revenue by Pharmacy Over Time'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xAxisLabel
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Revenue (¬£)'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    }
                }
            });
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('Please select a CSV file.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showLoading();

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    current_data = null;
                } else {
                    showAlert(data.message, 'success');
                    // Handle both response structures: nested stats or direct stats
                    const statsData = data.stats || data;
                    current_data = true; // Mark that data has been loaded
                    updateStats(statsData);
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Error uploading file: ' + error.message, 'error');
            });
        }

        // Load stats on page load if data exists
        fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                current_data = true; // Mark that data exists
                updateStats(data);
            }
        })
        .catch(error => {
            console.log('No existing data loaded');
        });

        // Modal functionality
        function showPharmaciesListModal() {
            if (current_data === null) {
                showAlert('No data loaded. Please upload a CSV file first.', 'error');
                return;
            }
            
            // Fetch pharmacies and populate modal
            fetch('/api/pharmacies')
            .then(response => response.json())
            .then(pharmacyDetails => {
                if (Array.isArray(pharmacyDetails)) {
                    populatePharmaciesListDisplay(pharmacyDetails);
                    document.getElementById('pharmaciesListModal').style.display = 'block';
                } else {
                    showAlert('Error loading pharmacies list', 'error');
                }
            })
            .catch(error => {
                console.error('Error fetching pharmacies:', error);
                showAlert('Error loading pharmacies list', 'error');
            });
        }

        function closePharmaciesListModal() {
            document.getElementById('pharmaciesListModal').style.display = 'none';
        }

        function populatePharmaciesListDisplay(pharmacyDetails) {
            const listContainer = document.getElementById('pharmaciesListDisplay');
            listContainer.innerHTML = '';
            
            // Count acquired vs pipeline
            let acquiredCount = 0;
            let pipelineCount = 0;
            
            // Sort by status (acquired first) then by name
            pharmacyDetails.sort((a, b) => {
                if (a.status === b.status) {
                    return a.name.localeCompare(b.name);
                }
                return a.status === 'acquired' ? -1 : 1;
            });
            
            pharmacyDetails.forEach((pharmacy, index) => {
                if (pharmacy.status === 'acquired') {
                    acquiredCount++;
                } else {
                    pipelineCount++;
                }
                
                const pharmacyItem = document.createElement('div');
                pharmacyItem.className = 'pharmacy-list-item';
                
                const statusIcon = document.createElement('span');
                statusIcon.className = `status-icon ${pharmacy.status}`;
                statusIcon.textContent = '‚óè';
                
                const numberSpan = document.createElement('span');
                numberSpan.className = 'pharmacy-number';
                numberSpan.textContent = index + 1;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'pharmacy-name';
                nameSpan.textContent = pharmacy.name;
                
                const dateSpan = document.createElement('span');
                dateSpan.className = 'pharmacy-acquisition-date';
                if (pharmacy.acquisition_date) {
                    dateSpan.textContent = pharmacy.acquisition_date;
                } else {
                    dateSpan.textContent = 'TBD';
                    dateSpan.style.fontStyle = 'italic';
                    dateSpan.style.color = '#999';
                }
                
                pharmacyItem.appendChild(statusIcon);
                pharmacyItem.appendChild(numberSpan);
                pharmacyItem.appendChild(nameSpan);
                pharmacyItem.appendChild(dateSpan);
                
                listContainer.appendChild(pharmacyItem);
            });
            
            // Update summary counts
            document.getElementById('acquiredCount').textContent = acquiredCount;
            document.getElementById('pipelineCount').textContent = pipelineCount;
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const pharmaciesListModal = document.getElementById('pharmaciesListModal');
            const revenueModal = document.getElementById('monthlyRevenueModal');
            
            if (event.target === pharmaciesListModal) {
                closePharmaciesListModal();
            } else if (event.target === revenueModal) {
                closeMonthlyRevenueModal();
            }
        }

        // Make current_data accessible for modal check
        let current_data = null;
        let currentSelectedPeriod = null;
        let currentViewType = 'month';

        // View Type Change Handler
        function changeViewType() {
            const viewType = document.getElementById('viewType').value;
            currentViewType = viewType;
            
            // Update labels based on view type
            updateViewLabels(viewType);
            
            // Initialize date range selector for month view
            initializeDateRangeSelector();
            
            // Reload revenue data for the new view type
            loadCurrentPeriodRevenue();
            
            // Update chart if pharmacy selector is loaded
            if (document.querySelector('#pharmacyCheckboxes').children.length > 0) {
                updateChartWithSelection();
            }
        }

        function updateViewLabels(viewType) {
            const cardLabel = document.getElementById('monthlyRevenueLabel');
            const modalTitle = document.querySelector('#monthlyRevenueModal .modal-header h2');
            const modalSubtitle = document.querySelector('.month-selector h4');
            
            switch(viewType) {
                case 'month':
                    if (cardLabel) cardLabel.textContent = 'Current Live Month Revenue';
                    if (modalTitle) modalTitle.textContent = 'Select Month for Revenue';
                    if (modalSubtitle) modalSubtitle.textContent = 'Select Different Month:';
                    break;
                case 'fiscal_year':
                    if (cardLabel) cardLabel.textContent = 'Current Fiscal Year Revenue';
                    if (modalTitle) modalTitle.textContent = 'Select Fiscal Year for Revenue';
                    if (modalSubtitle) modalSubtitle.textContent = 'Select Different Fiscal Year:';
                    break;
                case 'quarter':
                    if (cardLabel) cardLabel.textContent = 'Current Quarter Revenue';
                    if (modalTitle) modalTitle.textContent = 'Select Quarter for Revenue';
                    if (modalSubtitle) modalSubtitle.textContent = 'Select Different Quarter:';
                    break;
            }
        }

        // Monthly Revenue Modal Functions
        function showMonthlyRevenueModal() {
            if (current_data === null) {
                showAlert('No data loaded. Please upload a CSV file first.', 'error');
                return;
            }
            
            // Fetch available periods and current period revenue
            fetch(`/api/revenue-by-period?view_type=${currentViewType}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Error loading revenue data: ' + data.error, 'error');
                } else {
                    populatePeriodsList(data.periods, data.current_period, data.current_revenue);
                    document.getElementById('monthlyRevenueModal').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching revenue data:', error);
                showAlert('Error loading revenue data', 'error');
            });
        }

        function closeMonthlyRevenueModal() {
            document.getElementById('monthlyRevenueModal').style.display = 'none';
        }

        function populatePeriodsList(periods, currentPeriod, currentRevenue) {
            currentSelectedPeriod = currentPeriod;
            
            // Find current period data for percentage change
            const currentPeriodData = periods.find(p => p.period === currentPeriod);
            
            // Update current selection display
            document.getElementById('selectedMonthDisplay').textContent = currentPeriod;
            document.getElementById('selectedMonthRevenue').textContent = '¬£' + currentRevenue.toLocaleString();
            
            // Update main card percentage change if current period data exists
            if (currentPeriodData) {
                const revenueChangeEl = document.getElementById('revenueChange');
                const changeIconEl = document.getElementById('changeIcon');
                const changePercentageEl = document.getElementById('changePercentage');
                
                if (currentPeriodData.percentage_change !== null) {
                    const icon = currentPeriodData.change_direction === 'increase' ? '‚Üó' : '‚Üò';
                    const colorClass = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const changeText = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                            currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                    
                    changeIconEl.textContent = icon;
                    changePercentageEl.textContent = Math.abs(currentPeriodData.percentage_change) + '%';
                    
                    revenueChangeEl.className = `revenue-change ${colorClass}`;
                    revenueChangeEl.title = `${Math.abs(currentPeriodData.percentage_change)}% ${changeText} from ${previousPeriodText}`;
                    revenueChangeEl.style.display = 'flex';
                } else {
                    revenueChangeEl.style.display = 'none';
                }
            }
            
            // Populate periods grid
            const periodsList = document.getElementById('monthsList');
            periodsList.innerHTML = '';
            
            periods.forEach(periodData => {
                const periodButton = document.createElement('button');
                periodButton.className = 'month-button';
                if (periodData.period === currentPeriod) {
                    periodButton.classList.add('selected');
                }
                
                // Create percentage change display
                let changeDisplay = '';
                if (periodData.percentage_change !== null) {
                    const changeClass = periodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const changeIcon = periodData.change_direction === 'increase' ? '‚Üó' : '‚Üò';
                    const changeText = periodData.change_direction === 'increase' ? 'increase' : 'decrease';
                    const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                            currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                    changeDisplay = `
                        <div class="month-change ${changeClass}" title="${Math.abs(periodData.percentage_change)}% ${changeText} from ${previousPeriodText}">
                            <span class="change-icon">${changeIcon}</span>
                            <span>${Math.abs(periodData.percentage_change)}%</span>
                        </div>
                    `;
                }
                
                periodButton.innerHTML = `
                    <div class="month-name">${periodData.period}</div>
                    <div class="month-revenue">¬£${periodData.revenue.toLocaleString()}</div>
                    ${changeDisplay}
                `;
                
                periodButton.onclick = () => selectPeriod(periodData.period, periodData.revenue, periodData.percentage_change, periodData.change_direction);
                periodsList.appendChild(periodButton);
            });
        }

        function selectPeriod(period, revenue, percentageChange, changeDirection) {
            currentSelectedPeriod = period;
            
            // Update display
            document.getElementById('selectedMonthDisplay').textContent = period;
            document.getElementById('selectedMonthRevenue').textContent = '¬£' + revenue.toLocaleString();
            
            // Update main scorecard
            document.getElementById('monthlyRevenue').textContent = '¬£' + revenue.toLocaleString();
            document.getElementById('monthlyRevenueLabel').textContent = period + ' Revenue';
            
            // Update percentage change in main card
            const revenueChangeEl = document.getElementById('revenueChange');
            const changeIconEl = document.getElementById('changeIcon');
            const changePercentageEl = document.getElementById('changePercentage');
            
                                     if (percentageChange !== null) {
                const icon = changeDirection === 'increase' ? '‚Üó' : '‚Üò';
                const colorClass = changeDirection === 'increase' ? 'increase' : 'decrease';
                const changeText = changeDirection === 'increase' ? 'increase' : 'decrease';
                const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                        currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                
                changeIconEl.textContent = icon;
                changePercentageEl.textContent = Math.abs(percentageChange) + '%';
                
                revenueChangeEl.className = `revenue-change ${colorClass}`;
                revenueChangeEl.title = `${Math.abs(percentageChange)}% ${changeText} from ${previousPeriodText}`;
                revenueChangeEl.style.display = 'flex';
            } else {
                revenueChangeEl.style.display = 'none';
            }
            
            // Update button selection
            document.querySelectorAll('.month-button').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.month-button').classList.add('selected');
        }

        function loadCurrentPeriodRevenue() {
            if (current_data === null) return;
            
            fetch(`/api/revenue-by-period?view_type=${currentViewType}`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('monthlyRevenue').textContent = '¬£' + data.current_revenue.toLocaleString();
                    
                    // Update label based on view type
                    let labelSuffix = '';
                    if (currentViewType === 'month') {
                        labelSuffix = ' (Current Live Month)';
                    } else if (currentViewType === 'fiscal_year') {
                        labelSuffix = ' (Current Fiscal Year)';
                    } else if (currentViewType === 'quarter') {
                        labelSuffix = ' (Current Quarter)';
                    }
                    document.getElementById('monthlyRevenueLabel').textContent = data.live_period + ' Revenue' + labelSuffix;
                    
                    // Find current period data for percentage change
                    const currentPeriodData = data.periods.find(p => p.period === data.current_period);
                    const revenueChangeEl = document.getElementById('revenueChange');
                    const changeIconEl = document.getElementById('changeIcon');
                    const changePercentageEl = document.getElementById('changePercentage');
                    
                    if (currentPeriodData && currentPeriodData.percentage_change !== null) {
                        const icon = currentPeriodData.change_direction === 'increase' ? '‚Üó' : '‚Üò';
                        const colorClass = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                        const changeText = currentPeriodData.change_direction === 'increase' ? 'increase' : 'decrease';
                        const previousPeriodText = currentViewType === 'month' ? 'previous month' : 
                                                currentViewType === 'fiscal_year' ? 'previous fiscal year' : 'previous quarter';
                        
                        changeIconEl.textContent = icon;
                        changePercentageEl.textContent = Math.abs(currentPeriodData.percentage_change) + '%';
                        
                        revenueChangeEl.className = `revenue-change ${colorClass}`;
                        revenueChangeEl.title = `${Math.abs(currentPeriodData.percentage_change)}% ${changeText} from ${previousPeriodText}`;
                        revenueChangeEl.style.display = 'flex';
                    } else {
                        revenueChangeEl.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading current period revenue:', error);
            });
        }
    </script>
</body>
</html> 